stages:
  - build
  - deploy

variables:
  REGISTRY_BASE: registry.gitlab.com/deheritance/vault
  BACKEND_IMAGE: $REGISTRY_BASE:backend
  FRONTEND_IMAGE: $REGISTRY_BASE:frontend
  DOCKER_TLS_CERTDIR: ""

.docker_setup:
  image: docker:20.10
  services:
    - name: docker:20.10-dind
      alias: docker
      command: ["--tls=false"]
  before_script:
    - docker login registry.gitlab.com -u $CI_TOKEN_NAME -p $CI_TOKEN_PASSWORD

# --- BUILD STAGE ---

build-backend:
  extends: .docker_setup
  stage: build
  script:
    - docker build -t $BACKEND_IMAGE -f backend/Dockerfile backend/
    - docker push $BACKEND_IMAGE
  only:
    - main

build-frontend:
  extends: .docker_setup
  stage: build
  script:
    - docker build -t $FRONTEND_IMAGE -f frontend/Dockerfile frontend/
    - docker push $FRONTEND_IMAGE
  only:
    - main

# --- DEPLOY STAGE ---

deploy:
  image: docker:20.10
  stage: deploy
  needs:
    - build-backend
    - build-frontend
  before_script:
    - mkdir -p ~/.ssh
    - which ssh-agent || ( apk update -y && apk install openssh-client -y )
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIV_KEY_B64" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-add ~/.ssh/id_rsa
  script:
    - |
      ssh -T -p $SERVER_PORT -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$SERVER_USER@$SERVER_IP" <<EOF
        set -e
        
        # Navigate to project root directory
        cd $PROJECT_ROOT_PATH
        echo "ðŸ“ Working directory: \$(pwd)"
        git stash && git pull
        
        docker login registry.gitlab.com -u $CI_TOKEN_NAME -p $CI_TOKEN_PASSWORD
        
        # Load environment variables from .env file
        if [ -f "$PATH_ENV_FILE" ]; then
          echo "âœ… Loading environment from $PATH_ENV_FILE"
          set -a
          source $PATH_ENV_FILE
          set +a
        else
          echo "âŒ ERROR: .env file not found at $PATH_ENV_FILE"
          exit 1
        fi
        
        export BACKEND_IMAGE=$BACKEND_IMAGE
        export FRONTEND_IMAGE=$FRONTEND_IMAGE
        export NGINX_PORT=\${NGINX_PORT:-7000}
        
        # Ensure correct backend URL for Docker internal network
        export BACKEND_BASE_URL=http://backend:7002
        
        echo "Pulling latest images..."
        docker compose pull
        
        echo "Starting services..."
        
        docker compose up -d --force-recreate --remove-orphans
        
        echo "Cleaning up old images..."
        docker image prune -f
        docker builder prune -f
        
        docker logout
      EOF
  only:
    - main